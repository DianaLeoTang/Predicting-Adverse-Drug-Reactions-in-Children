# 项目代码结构说明

## 项目概述
本项目是一个用于预测儿童药物不良反应（ADR）的机器学习系统，通过整合FAERS数据库、信号检测算法、生物特征提取和机器学习模型，构建了一个完整的数据处理和预测流程。

---

## 核心文件说明

### 1. **dataset_make.py** - 数据集构建与标签生成
**功能**：这是数据预处理的核心文件，负责从FAERS信号检测结果生成最终的训练标签。

**主要功能模块**：
- **多数投票标签生成** (`create_labels_with_majority_vote`)：
  - 读取信号检测结果CSV文件
  - 根据FDA黑框ADR列表进行分类（区分黑框ADR和普通ADR）
  - 使用多种信号检测方法（ROR、PRR、BCPNN、EBGM）进行投票
  - 对黑框ADR使用高灵敏度方法（ROR_No_A、PRR_No_A、BCPNN_GT0、EBGM）
  - 对非黑框ADR使用高特异度方法（ROR、PRR、BCPNN_GT3、EBGM）
  - 通过多数投票规则生成最终标签（Final_Label）

- **ADR终点筛选**（注释代码）：
  - 根据缺失值比例和平衡性筛选ADR终点
  - 计算每个ADR的0/1/NaN比例和平衡比率
  - 生成统计报告

- **SMILES匹配**（注释代码）：
  - 将药物名称与SMILES字符串进行匹配
  - 处理未匹配的药物

- **数据集分类**（注释代码）：
  - 根据ADR分类表将数据集按系统分类
  - 生成多个子数据集用于多任务学习

- **SMILES去氢处理**（注释代码）：
  - 使用RDKit去除SMILES中的氢原子
  - 标准化分子表示

---

### 2. **smiles.py** - SMILES字符串获取
**功能**：从PubChem数据库批量获取药物的SMILES表示。

**主要功能**：
- 读取包含药物名称的CSV文件
- 通过PubChem REST API批量查询每个药物的：
  - CanonicalSMILES（规范SMILES）
  - IsomericSMILES（异构SMILES，优先使用）
  - 其他分子信息（分子式、分子量、IUPAC名称等）
- 处理查询失败的情况
- 将结果保存为Excel文件

**使用场景**：当需要为药物列表补充SMILES信息时使用。

---

### 3. **faers.py** / **testfaers.py** - FAERS数据库查询
**功能**：从FAERS（FDA不良事件报告系统）数据库中提取药物和不良反应信息。

**主要功能**：
- 连接SQLite格式的FAERS数据库
- 解析药物和适应症列表文件
- 查询特定药物在特定适应症下的不良反应报告
- 生成包含统计信息的报告

**使用场景**：从FAERS数据库提取原始的不良反应报告数据。

---

### 4. **Biofeat/bio_feat_ty.py** - 生物特征提取
**功能**：使用Chemical Checker方法将SMILES转换为生物特征向量（BioFeat）。

**主要功能**：
- 初始化Signaturizer模型（使用25个预训练模型：A1-A5, B1-B5, C1-C5, D1-D5, E1-E5）
- 验证SMILES字符串的有效性
- 批量处理SMILES，生成生物特征签名（signature）
- 将特征向量转换为JSON字符串格式存储
- 记录处理统计信息（有效/无效SMILES数量）

**技术细节**：
- 使用`signaturizer`库（基于Chemical Checker）
- 特征维度：每个模型生成一个特征向量，25个模型组合
- 输出格式：JSON字符串，便于CSV存储

**使用场景**：为机器学习模型准备生物特征输入。

---

### 5. **Main_model/tabpfn_biofeat.py** - TabPFN模型训练
**功能**：使用TabPFN（Tabular Prior-data Fitted Networks）模型进行多任务ADR预测。

**主要功能**：
- **数据加载与预处理**：
  - 读取包含标签和SMILES的数据集
  - 读取包含BioFeat的数据集
  - 合并数据并解析BioFeat为数值向量

- **特征选择**：
  - 使用互信息（Mutual Information）进行特征选择
  - 在每折交叉验证的训练集上拟合选择器，避免信息泄漏
  - 默认选择500个特征

- **模型训练与评估**：
  - 使用AutoTabPFNClassifier（自动调参版本）
  - 分层10折交叉验证
  - 可选的外部留出集评估

- **评估指标**：
  - ROC AUC、PR AUC、Accuracy、F1、MCC
  - Balanced Accuracy、Sensitivity、Specificity

- **结果保存**：
  - 每折的指标和预测结果
  - 任务级汇总报告
  - 全局汇总日志

**特点**：
- TabPFN是一个基于Transformer的表格数据分类器
- 在小样本场景下表现优异
- 支持自动超参数优化

---

### 6. **Main_model/xgboost_biofeat.py** - XGBoost模型训练
**功能**：使用XGBoost模型进行多任务ADR预测，结合Optuna进行超参数优化。

**主要功能**：
- **超参数优化**：
  - 使用Optuna框架进行贝叶斯优化
  - 优化目标：0.6 × ROC_AUC + 0.4 × PR_AUC
  - 搜索空间包括：learning_rate、max_depth、min_child_weight、subsample、colsample_bytree、gamma、正则化参数等
  - 默认100次试验，支持超时设置

- **模型训练**：
  - 使用最佳超参数训练XGBoost模型
  - 支持GPU加速（可选）
  - 早停机制防止过拟合

- **评估流程**：
  - 分层10折交叉验证
  - 可选的外部留出集评估
  - 保存最终模型

- **评估指标**：与TabPFN相同

**特点**：
- XGBoost是梯度提升树模型，在表格数据上表现优异
- 通过Optuna自动搜索最优超参数
- 支持大规模数据训练

---

## FAERS Extract 目录说明

### **FAERS extract/package/faers/** - FAERS数据处理工具包

#### **signal_scores.py** - 信号检测算法
**功能**：实现药物不良反应信号检测的统计方法。

**主要算法**：
- **PRR (Proportional Reporting Ratio)**：比例报告比
- **ROR (Reporting Odds Ratio)**：报告优势比，包括95%置信区间计算

**使用场景**：在FAERS数据分析中计算药物-不良反应对的信号强度。

#### **dbutils.py** - 数据库工具
**功能**：提供FAERS数据库查询和处理的工具函数。

**主要功能**：
- 连接和查询FAERS数据库
- 提取药物-不良反应关联数据
- 计算统计指标
- 生成报告

#### **其他工具文件**：
- **queryhelper.py**：SQL查询辅助函数
- **cleandb.py**：数据库清理工具
- **dbstats.py**：数据库统计工具

---

## 数据流程

```
1. FAERS数据库
   ↓
2. faers.py / testfaers.py (提取原始数据)
   ↓
3. dataset_make.py (信号检测 + 多数投票 → 生成标签)
   ↓
4. smiles.py (获取SMILES字符串)
   ↓
5. Biofeat/bio_feat_ty.py (SMILES → 生物特征)
   ↓
6. Main_model/tabpfn_biofeat.py 或 xgboost_biofeat.py (模型训练与评估)
   ↓
7. 预测结果和评估报告
```

---

## 关键技术点

### 1. **信号检测方法**
- **ROR (Reporting Odds Ratio)**：报告优势比
- **PRR (Proportional Reporting Ratio)**：比例报告比
- **BCPNN (Bayesian Confidence Propagation Neural Network)**：贝叶斯置信传播神经网络
- **EBGM (Empirical Bayes Geometric Mean)**：经验贝叶斯几何均值

### 2. **多数投票策略**
- 对FDA黑框ADR：使用高灵敏度方法，至少2个信号即判定为阳性
- 对普通ADR：使用高特异度方法，至少2个信号即判定为阳性

### 3. **生物特征提取**
- 使用Chemical Checker的25个预训练模型
- 每个模型捕获不同层面的生物活性信息
- 组合后形成高维生物特征向量

### 4. **模型选择**
- **TabPFN**：适合小样本、自动调参
- **XGBoost**：适合大规模数据、需要手动调参（使用Optuna自动化）

### 5. **评估策略**
- 分层10折交叉验证（保持类别分布）
- 外部留出集评估（最终模型性能）
- 多指标评估（ROC AUC、PR AUC、F1等）

---

## 文件依赖关系

```
dataset_make.py
  ├─ 依赖: FAERS信号检测结果CSV
  └─ 输出: 带标签的数据集CSV

smiles.py
  ├─ 依赖: 药物名称列表
  └─ 输出: 药物-SMILES映射表

Biofeat/bio_feat_ty.py
  ├─ 依赖: SMILES数据
  └─ 输出: BioFeat特征CSV

Main_model/*.py
  ├─ 依赖: 标签数据集 + BioFeat特征
  └─ 输出: 模型、预测结果、评估报告
```

---

## 使用建议

1. **数据准备阶段**：
   - 先运行FAERS数据提取
   - 使用dataset_make.py生成标签
   - 使用smiles.py获取SMILES
   - 使用bio_feat_ty.py生成生物特征

2. **模型训练阶段**：
   - 根据数据规模选择模型（小样本用TabPFN，大样本用XGBoost）
   - 调整交叉验证折数和特征选择参数
   - 监控训练日志和评估指标

3. **结果分析**：
   - 查看每折的评估指标
   - 分析任务级汇总报告
   - 对比不同模型的性能

---

## 注意事项

1. **数据路径**：代码中包含硬编码路径，需要根据实际环境修改
2. **模型文件**：TabPFN和Chemical Checker需要预训练模型文件
3. **计算资源**：生物特征提取和模型训练需要较大计算资源
4. **断点续跑**：两个模型训练脚本都支持从指定任务开始继续运行
5. **注释代码**：dataset_make.py中包含大量注释代码，是不同处理阶段的实现

